pipeline {
    agent {
        node { label 'zOS_Share' } 
    }

    stages {
        stage('Checkout') {
            steps {
                echo "Checking out source code from Git..."
                checkout scm
                echo "Done checking out source code."
            }
        }
        stage('Setup Environment') {
            environment {
                NODE_ENV = "test"
            }
            steps {
                echo "Begin setup..."
                echo "Node environment is: ${env.NODE_ENV}"
                // sh 'export PATH=$PATH:/usr/lpp/IBM/cnj/IBM/node-v6.11.2-os390-s390x/bin/'
                // sh 'echo $PATH'
                // sh 'type node'
                sh 'node --version'
                sh 'npm prune'
                sh 'npm install'
                echo "End setup."
            }
        }
        stage('Testing') {
            environment {
                NODE_ENV = "test"
            }
            steps {
                echo "Begin testing..."
                sh 'npm test'
                echo "testing complete."
            }
        }
        stage('Deploy') {
            environment {
                NODE_ENV = "production"
                NODE_PORT = 3000
            }
            steps {
                sh "echo \"Begin deployment in directory $(pwd)...\""
                sh "npm restart:server"
            }
        }
        /*
        stage('Prune and Cleanup') {
            steps {
                echo "Skipping building stage. "
                // Clean up remaining node_modules and extra files
                // to prevent filespace pollution and running out
                // of disk space.
                sh 'rm -rf node_modules/'
            }
        }
        */
    }

    post {
            failure {
                echo "Build failed!"
            }
            unstable {
                echo "Build unstable; check tests for failures."
            }
        }
}